/*
// BEGIN__HARVEST_EXCEPTION_ZSTRING
<javascriptresource>
<name>[A] Schlussschuss2</name>
<about>Photoshop-Script to RZ | By Simon Adrian | http://www.SimonAdrian.de</about>
<category>A f√§ngt an.</category>
</javascriptresource>
// END__HARVEST_EXCEPTION_ZSTRING
*/
/** last edited on 13.02.2025 12:26 **/
//@include "functions/basic.jsx";
//@include "functions/channel.jsx";
//@include "functions/dialog.jsx";
//@include "functions/view.jsx";
//@include "functions/layer.jsx";
//@include "functions/save.jsx";
//@include "functions/ready.jsx";
//@include "functions/utils.jsx";
//@include "functions/loopFiles.jsx";
//@include "functions/meta.jsx";
//@include "./assets/json2.js"
var jsonFilePath="~/.ss_settings.json",jsonData=loadJSON(jsonFilePath),saveFolder=jsonValue("RZ_saveFolder"),Suffix_RZ=jsonValue("RZ_suffix"),saveFormat=jsonValue("RZ_saveFormat"),delPath=jsonValue("RZ_delPath"),sharp_dialog=jsonValue("RZ_sharpDialog"),RZ_qualityJPG=jsonValue("RZ_qualityJPG"),RZ_alphaChannels=jsonValue("RZ_alphaChannels"),RZ_withLayers=jsonValue("RZ_withLayers");const debug=Boolean(jsonValue("Debug"));function sharp(e){var t=getZoomLevel();app_panelsVisible()&&togglePalettes(),zoom100();try{executeAction(stringIDToTypeID("unsharpMask"),void 0,e)}catch(e){}app_panelsVisible()||togglePalettes(),setZoom(t)}function convertToProfil_menu(){var e=new ActionDescriptor,t=new ActionReference;t.putEnumerated(s2t("document"),s2t("ordinal"),s2t("targetEnum")),e.putReference(s2t("null"),t),executeAction(s2t("convertToProfile"),e,DialogModes.ALL)}function convertProfile_metaSoftproof(){if(editXMP_3(),xmpMeta.doesPropertyExist(nsURI,"softproofProfil")&&xmpMeta.doesPropertyExist(nsURI,"softproofIntent")&&xmpMeta.doesPropertyExist(nsURI,"softproofTK")){var e=xmpMeta.getProperty(nsURI,"softproofProfil"),t=xmpMeta.getProperty(nsURI,"softproofIntent"),a=Boolean(xmpMeta.getProperty(nsURI,"softproofTK"));if("image"==t)t=Intent.PERCEPTUAL;else if("colorimetric"==t)t=Intent.RELATIVECOLORIMETRIC;else if("graphics"==t)t=Intent.SATURATION;else if("absColorimetric"==t)t=Intent.ABSOLUTECOLORIMETRIC;doc.convertProfile(e,t,a,!0)}else convertToProfil_menu()}function replace_RGB_to_RZ(){return GetFileNameOnly(doc.name).replace(/(__RGB.*)$/g,Suffix_RZ)}function dialog_missingSoftproof(){return dialog_createDialog("Schlussschuss","Du hast den Softproof vergessen","Egal -> weiter","Oh nein -> stopp").show()?0:1}function dialog_saveWorkingfile(){return dialog_createDialog("Schlussschuss","vorher speichern?","Ja","Nein").show()?0:1}function checkBeforeRun(){if(editXMP_3(),xmpMeta.doesPropertyExist(nsURI,"softproofProfil")&&xmpMeta.doesPropertyExist(nsURI,"softproofIntent")&&xmpMeta.doesPropertyExist(nsURI,"softproofTK"))run(saveFolder);else{if(!dialog_missingSoftproof())return;run(saveFolder)}}function run(a){var o=app.activeDocument;0==o.saved&&dialog_saveWorkingfile()&&o.save();var r=!1;if(getMeta_3("isWoodwing"))r=Boolean(getMeta_3("isWoodwing"));if(getMeta_3("arbeitsdatei_RGB"))getMeta_3("arbeitsdatei_RGB");if(getMeta_3("woodwing_RGB"))var n=getMeta_3("woodwing_RGB");if(getMeta_3("woodwing_file"))var i=getMeta_3("woodwing_file");if(getMeta_3("woodwing_imageID"))getMeta_3("woodwing_imageID");if(getMeta_3("idDocName"))var s=getMeta_3("idDocName");try{hide("Layout"),debug&&alert("Layout versteckt")}catch(t){debug&&alert("Layout nicht gefunden: "+e)}if(r){try{BridgeTalkMessage_openDocID(s,i,debug)}catch(e){debug&&alert("bt: "+e)}try{closeDoc(i)}catch(e){debug&&alert("closeDoc+: "+e)}var c=n}else{var l=new Folder(a);l.exists||l.create();c=l+"/"+replace_RGB_to_RZ()+"."+saveFormat}try{o.layerSets.getByName("Freisteller")&&(r?app.activeDocument.suspendHistory("Freisteller: 2 Ebenen","freisteller_reduce2layers()"):(gotoLayer("Freisteller"),fixMask(getActiveLayerIndex(),1),duplicateLayerMaskAsAlpha(),setMaskVisibility(!1),selectLayers("selectAllLayers"),mergeLayers(),setBackTheLayerMask(),setMaskVisibility(!1)))}catch(e){flattenImage()}RemoveAlphaChannels(),convertProfile_metaSoftproof(),sharp(sharp_dialog?DialogModes.ALL:DialogModes.NO),o.bitsPerChannel!=BitsPerChannelType.EIGHT&&setBitDepth(8),clearAllGuides(),delMeta_3(["softproofProfil","softproofIntent","softproofTK","softproofGroup"]),delPath&&activeDocument.pathItems.removeAll();try{if(r&&o.artLayers.getByName("frei"))return void saveMultiformat(new File(c),"psd",!1,null,RZ_alphaChannels,!0)}catch(e){}try{if(o.artLayers.getByName("Freisteller")){setMaskVisibility(!0);var u=l+"/"+replace_RGB_to_RZ()+"-frei";savePSD_v2(new File(u),t,t,t,f),setMaskVisibility(!1)}}catch(e){}try{flattenImage(),saveMultiformat(new File(c),saveFormat,!1,RZ_qualityJPG,RZ_alphaChannels,RZ_withLayers)}catch(e){debug&&alert("save: "+e)}}function closeDoc(e){try{app.documents.getByName(decodeURI(e)).close(SaveOptions.DONOTSAVECHANGES)}catch(t){debug&&alert("closeDoc: "+e+" :--: "+t)}}function BridgeTalkMessage_openDocID(e,t,a){var o=new BridgeTalk;o.target="indesign",o.body=runID.toSource()+"('"+e+"','"+t+"','"+a+"');",o.onResult=function(e){},o.send(10)}function runID(e,t,a){try{if(function(e){for(var t=!1,a=0;a<app.documents.length;a++)if(-1!==app.documents[a].name.indexOf(e)){t=!0,app.activeDocument=app.documents[a];break}return t}(e))app.activeDocument.links.itemByName(t).editOriginal();else alert("kein Focus auf der Datei?")}catch(e){}return" "}function BridgeTalkMessage_checkOutImage(e,t){var a=new BridgeTalk;a.target="indesign",a.body=runID_checkOutImage.toSource()+"('"+e+"','"+t+"');",a.onResult=function(e){},a.send(10)}function BridgeTalkMessage_checkInImage(e,t){var a=new BridgeTalk;a.target="indesign",a.body=runID_checkInImage.toSource()+"('"+e+"','"+t+"');",a.onResult=function(e){},a.send(10)}function runID_checkOutImage(e,t){try{if(function(e){for(var t=!1,a=0;a<app.documents.length;a++)if(-1!==app.documents[a].name.indexOf(e)){t=!0,app.activeDocument=app.documents[a];break}return t}(e)){var a=function(e,t){try{for(var a=-1,o=0;i<e.length;o++)if(e[o]===t){a=o;break}return a}catch(e){alert(e)}}(function(){var e=[];try{for(var t=app.activeDocument.managedImages,a=0;a<t.length;a++){var o=t[a].entMetaData.get("Core_ID");e.push(o)}return e}catch(e){alert(e)}}(),t);app.activeDocument.managedImages[a].checkOut()}else alert("kein Focus auf der Datei?")}catch(e){alert("runID_checkOutImage: "+e)}}function runID_checkInImage(e,t){try{if(function(e){for(var t=!1,a=0;a<app.documents.length;a++)if(-1!==app.documents[a].name.indexOf(e)){t=!0,app.activeDocument=app.documents[a];break}return t}(e)){var a=function(){var e=[];try{for(var t=app.activeDocument.managedImages,a=0;a<t.length;a++){var o=t[a].entMetaData.get("Core_ID");e.push(o)}return e}catch(e){alert(e)}}(),o=function(e,t){try{for(var a=-1,o=0;i<e.length;o++)if(e[o]===t){a=o;break}return a}catch(e){alert(e)}}(a,t);app.activeDocument.managedImages[o].pageItem[0].placeObject(a[o]),app.activeDocument.managedImages[o].checkIn()}else alert("kein Focus auf der Datei?")}catch(e){alert("runID_1: "+e)}}checkBeforeRun();