// enable double clicking from the 
// Macintosh Finder or the Windows Explorer
// #target indesign
/* VARIBALES*/
//~ var master = new File("/Volumes/grafik/Fach_Grafik/11F_3D-Heft/Master/3D__11F-innen__MASTER.tif");
/* DIALOG*/
var a_dialog=app.dialogs.add({name:"3D-Heft",canCancel:!1}),min_width_left=50,min_width_right=250,heft1="11Freunde",heft2="noSports",heft3="Chronik";with(a_dialog)with(dialogColumns.add())with(borderPanels.add()){with(dialogColumns.add())staticTexts.add({staticLabel:"Heft:",minWidth:min_width_left});with(dialogColumns.add()){var heft=radiobuttonGroups.add();with(heft)radiobuttonControls.add({staticLabel:heft1,checkedState:!0,minWidth:min_width_right}),radiobuttonControls.add({staticLabel:heft2,checkedState:!1,minWidth:min_width_right}),radiobuttonControls.add({staticLabel:heft3,checkedState:!1,minWidth:min_width_right})}}if(0==a_dialog.show())a_dialog.destroy();else{if(0==heft.selectedButton)var heft=heft1,master=new File("/Users/simon/Arbeit/11Freunde/3D/11F_3D-Heft/Master/3D__11F-innen__MASTER_v5_flach.tif");
//~             var master = new File("/Volumes/grafik/Fach_Grafik/11F_3D-Heft/Master/3D__11F-innen__MASTER.tif");
// var master = new File("/Volumes/grafik/Fach_Grafik/11F_3D-Heft/Master/3D__11F-innen__MASTER_v5_flach.tif");
else if(1==heft.selectedButton)var heft=heft2,master=new File("/Volumes/grafik/Fach_Grafik/11F_3D-Heft/Master/3D__noSports-innen__MASTER.tif");else if(2==heft.selectedButton)var heft=heft3,master=new File("/Users/simon/Arbeit/11Freunde/3D/11F_3D-Heft/Master/3D__Chronik-innen__MASTER_flach.tif");$.writeln(heft)}app.books.length<1&&errorExit("Fehler\rMindestens ein InDesign-Buch muß geöffnet sein."),app.documents.length>0&&errorExit("Fehler\rBitte vorher alle InDesign-Dokumente schließen."),outputFolder=Folder.selectDialog("Bitte wähle den Ordner der Rücklaufdaten aus");var Folder_single=new Folder(outputFolder+"/einzelSeiten"),Folder_3D=new Folder(outputFolder+"/3D");Folder_single.exists||Folder_single.create(),Folder_3D.exists||Folder_3D.create();for(var b=0;b<app.books.length;b++)doBook(app.books[b]);function doBook(e){for(var t=0;t<e.bookContents.length;t++)doDoc(e.bookContents[t]);
//~     return true;
}function doDoc(e){app.scriptPreferences.userInteractionLevel=UserInteractionLevels.neverInteract;try{var t=app.open(File(e.fullName));
////////////
if(0!=app.documents.length){var n=function(e){var t="",n=e.lastIndexOf(".");t=-1==n?e:e.substr(0,n);

// cut the leading page-numbers and hyphens // get the blank title
return t.replace(/^(\d{2,3})(-|_)(\d{2,3})(-|_)(.*)/g,"$5")}((t=app.activeDocument).name);null!=n&&function(){for(var e=0;e<t.pages.length;e++){""!=t.pages.item(e).appliedSection.name&&(t.pages.item(e).appliedSection.name="");var i=t.pages.item(e).name;app.jpegExportPreferences.jpegColorSpace=JpegColorSpaceEnum.RGB,app.jpegExportPreferences.jpegRenderingStyle=JPEGOptionsFormat.BASELINE_ENCODING,app.jpegExportPreferences.jpegQuality=JPEGOptionsQuality.maximum,// low medium high maximum  
app.jpegExportPreferences.exportResolution=300,app.jpegExportPreferences.jpegExportRange=ExportRangeOrAllPages.exportRange,app.jpegExportPreferences.pageString=i,app.jpegExportPreferences.exportingSpread=!1,app.jpegExportPreferences.antiAlias=!0,app.jpegExportPreferences.useDocumentBleeds=!1,app.jpegExportPreferences.embedColorProfile=!0,app.jpegExportPreferences.simulateOverprint=!0;i=("000"+i).slice(-3);// min 3 digits
var r=new File(Folder_single+"/"+i+"__"+n+".jpg");t.exportFile(ExportFormat.jpg,r,!1)}}()}else alert("Please open a document and try again.");
///////////
t.close()}catch(t){alert(e.fullName+"\r"+t)}app.scriptPreferences.userInteractionLevel=UserInteractionLevels.interactWithAll}function errorExit(e){alert(e),exit()}function closeAll(){for(;app.documents.length>0;)app.activeDocument.close(SaveOptions.DONOTSAVECHANGES)}
/*/// ENDE  Einzelseiten JPG-Export ///*/
//// FUNCTIONS ////
/* sort files alphabetically */function sort_pages(e){var t=e.sort(sortnum).join("\r")+"\r";return t=(t=(t=t.replace(/([^\r]+\r)(\1)+/g,"$1")).replace(/\r$/,"")).split("\r")}function sortnum(e,t){return e>t}function GetFileNameOnly(e){var t=e.lastIndexOf(".");return(-1==t?e:e.substr(0,t)).replace(/^(\d{3}(-|_{2}))(.+)/g,"$3")}function getPageNumber(e){var t=e.lastIndexOf(".");-1==t||e.substr(0,t);var n=e.replace(/^(\d{3})(-|_{2})(.+)/g,"$1");
//~     alert("rightPageNumber: " + rightPageNumber);
return("000"+(n-1)).slice(-3)+"-"+n}
/*/// START Liste der Einzelseiten ///*/
var fileList=Folder_single.getFiles(/.+\.jpg$/i);sort_pages(fileList);
// SCHLEIFE //
for(var thisSite="",thisFileName="",thisPageNumber="",i=0;i<fileList.length;i++){var thisFile=fileList[i];if(i+1&1){// ODD
var thisSite="links";id2ps_placeItem()}else{// EVEN
var thisSite="rechts",thisFileName=GetFileNameOnly(thisFile.name),thisPageNumber=getPageNumber(thisFile.name);id2ps_placeItem()}}function id2ps_placeItem(){var e=new BridgeTalk;e.target="photoshop",e.body=runPS.toSource()+"("+Folder_3D.toSource()+","+master.toSource()+","+thisFile.toSource()+","+thisSite.toSource()+","+thisFileName.toSource()+","+thisPageNumber.toSource()+");",e.onError=function(e){
/* alert("Error ding: " + e.body); */
$.writeln("Error ding: "+e.body)},e.onResult=function(e){},e.send(100)}function id2ps_schatten(){var e=new BridgeTalk;e.target="photoshop",e.body=runPS_schatten.toSource()+"("+Folder_3D.toSource()+","+master.toSource()+");",e.onError=function(e){alert("Error: "+e.body)},e.onResult=function(e){},e.send(100)}
/////////////////////////////////////////////////// PS
function tryPS(e){startDisplayDialogs=app.displayDialogs,startRulerUnits=app.preferences.rulerUnits,app.displayDialogs=DialogModes.NO,app.preferences.rulerUnits=Units.MM,gFilesToSkip=Array("db","xmp","thm","txt","doc","md0","tb0","adobebridgedb","adobebridgedbt","bc","bct",".DS_Store");var t=new File("/Volumes/grafik/Fach_Grafik/11F_3D-Heft/Master/3D__11F-innen__MASTER.tif"),n=new Folder(e+"/einzelSeiten"),i=new Folder(e+"/3D");function r(e){return app.charIDToTypeID(e)}function o(e,t){var n=e.toString().lastIndexOf(".");if(-1==n)return!1;var i=e.toString().length,r=e.toString().substr(n+1,i-n);r=r.toLowerCase();for(var o=0;o<t.length;o++)if(r==t[o])return!0;return!1}function a(e,t,n,i){var r=new File(e+"/"+i+"__"+n);tiffSaveOptions=new TiffSaveOptions,tiffSaveOptions.embedColorProfile=!0,tiffSaveOptions.alphaChannels=!1,tiffSaveOptions.layers=!1,tiffSaveOptions.byteOrder=ByteOrder.IBM,tiffSaveOptions.annotations=!1,tiffSaveOptions.transparency=!0,tiffSaveOptions.imageCompression=TIFFEncoding.TIFFLZW,app.activeDocument.saveAs(r,tiffSaveOptions,!0,Extension.LOWERCASE)}function s(){var e=new ActionDescriptor;e.putEnumerated(r("null"),r("PrgI"),r("Al  ")),executeAction(r("Prge"),e,DialogModes.NO);for(var t=app.activeDocument.historyStates,n=t.length-1;n>=0;--n)t[n].snapshot&&(app.activeDocument.activeHistoryState=t[n],p())}function p(){var e=new ActionDescriptor,t=new ActionReference;t.putProperty(charIDToTypeID("HstS"),charIDToTypeID("CrnH")),e.putReference(charIDToTypeID("null"),t),executeAction(charIDToTypeID("Dlt "),e,DialogModes.NO)}function l(e){var t=e.lastIndexOf(".");return(-1==t?e:e.substr(0,t)).replace(/^(\d{3}(-|_{2}))(.+)/g,"$3")}function c(e){var t=e.lastIndexOf("."),n=(-1==t?e:e.substr(0,t)).replace(/^(\d{3})(-|_{2})(.+)/g,"$1");return("000"+(n-1)).slice(-3)+"-"+n}function f(e,t){var n=new ActionDescriptor,i=new ActionReference;i.putName(r("Lyr "),e),n.putReference(r("null"),i),n.putBoolean(r("MkVs"),!1),executeAction(r("slct"),n,DialogModes.NO);var o=stringIDToTypeID("placedLayerEditContents"),a=new ActionDescriptor;executeAction(o,a,DialogModes.NO);var s=stringIDToTypeID("placedLayerReplaceContents"),p=new ActionDescriptor,l=charIDToTypeID("null");p.putPath(l,new File(t)),executeAction(s,p,DialogModes.NO);var c=charIDToTypeID("save");executeAction(c,void 0,DialogModes.NO);var f=stringIDToTypeID("updatePlacedLayer");executeAction(f,void 0,DialogModes.NO);var u=charIDToTypeID("Cls ");executeAction(u,void 0,DialogModes.NO)}!function(){var e=0,i=n.getFiles();alert(i);for(var r=0;r<i.length;r++)if(i[r]instanceof File&&!i[r].hidden&&!o(i[r],gFilesToSkip)){
/* alert(fileList[i]); */
if(e++,app.open(t),r+1&1)f("links",i[r]);else f("rechts",i[r]),a([r],l(i[r].name),c(i[r].name));s()}}(),function(){var e=new ActionDescriptor,t=new ActionList,n=new ActionReference;n.putName(r("Lyr "),"Magazin"),
/* ref10.putName( cTID('Lyr '), "doppelseite" ); */
/* ref10.putName( cTID('Lyr '), "Reflection" ); */
t.putReference(n),e.putList(r("null"),t),executeAction(r("Hd  "),e,DialogModes.NO);var o=new ActionDescriptor,a=new ActionList,s=new ActionReference;s.putProperty(r("Lyr "),r("Bckg")),a.putReference(s),o.putList(r("null"),a),executeAction(r("Shw "),o,DialogModes.NO);var p=new File(i+"/_Schatten__11F-innen");tiffSaveOptions=new TiffSaveOptions,tiffSaveOptions.embedColorProfile=!0,tiffSaveOptions.alphaChannels=!1,tiffSaveOptions.layers=!1,tiffSaveOptions.byteOrder=ByteOrder.IBM,tiffSaveOptions.annotations=!1,tiffSaveOptions.transparency=!1,tiffSaveOptions.imageCompression=TIFFEncoding.TIFFLZW,app.activeDocument.saveAs(p,tiffSaveOptions,!0,Extension.LOWERCASE)}(),app.activeDocument.close(SaveOptions.DONOTSAVECHANGES),app.preferences.rulerUnits=startRulerUnits,app.displayDialogs=startDisplayDialogs}function runPS(e,t,n,i,r,o){function a(e){return app.charIDToTypeID(e)}function s(){var e=new ActionDescriptor,t=new ActionReference;t.putProperty(charIDToTypeID("HstS"),charIDToTypeID("CrnH")),e.putReference(charIDToTypeID("null"),t),executeAction(charIDToTypeID("Dlt "),e,DialogModes.NO)}function p(e,t){
/*choose Layer*/
var n=new ActionDescriptor,i=new ActionReference;i.putName(a("Lyr "),e),n.putReference(a("null"),i),n.putBoolean(a("MkVs"),!1),executeAction(a("slct"),n,DialogModes.NO);
/* ======================================================= */
var r=stringIDToTypeID("placedLayerEditContents"),o=new ActionDescriptor;executeAction(r,o,DialogModes.NO);
/* ======================================================= */
var s=stringIDToTypeID("placedLayerReplaceContents"),p=new ActionDescriptor,l=charIDToTypeID("null");p.putPath(l,new File(t)),executeAction(s,p,DialogModes.NO);
/* ======================================================= */
var c=charIDToTypeID("save");executeAction(c,void 0,DialogModes.NO);
/* ======================================================= */
var f=stringIDToTypeID("updatePlacedLayer");executeAction(f,void 0,DialogModes.NO);
/* ======================================================= */
var u=charIDToTypeID("Cls ");executeAction(u,void 0,DialogModes.NO)}startDisplayDialogs=app.displayDialogs,startRulerUnits=app.preferences.rulerUnits,app.displayDialogs=DialogModes.NO,app.preferences.rulerUnits=Units.MM,
/* app.bringToFront(); */
app.open(t),"links"==i?p("links",n):(p("rechts",n),function(t,n){var i=new File(e+"/"+n+"__"+t);tiffSaveOptions=new TiffSaveOptions,tiffSaveOptions.embedColorProfile=!0,tiffSaveOptions.alphaChannels=!1,tiffSaveOptions.layers=!1,tiffSaveOptions.byteOrder=ByteOrder.IBM,tiffSaveOptions.annotations=!1,tiffSaveOptions.transparency=!0,tiffSaveOptions.imageCompression=TIFFEncoding.TIFFLZW,app.activeDocument.saveAs(i,tiffSaveOptions,!0,Extension.LOWERCASE)}(r,o)),function(){var e=new ActionDescriptor;e.putEnumerated(a("null"),a("PrgI"),a("Al  ")),executeAction(a("Prge"),e,DialogModes.NO);for(var t=app.activeDocument.historyStates,n=t.length-1;n>=0;--n)t[n].snapshot&&(app.activeDocument.activeHistoryState=t[n],s())}(),app.preferences.rulerUnits=startRulerUnits,app.displayDialogs=startDisplayDialogs}function runPS_schatten(e,t){function n(e){return app.charIDToTypeID(e)}startDisplayDialogs=app.displayDialogs,startRulerUnits=app.preferences.rulerUnits,app.displayDialogs=DialogModes.NO,app.preferences.rulerUnits=Units.MM,app.open(t),function(){var t=new ActionDescriptor,i=new ActionList,r=new ActionReference;r.putName(n("Lyr "),"Magazin"),
/*         ref10.putName( cTID('Lyr '), "doppelseite" );
                ref10.putName( cTID('Lyr '), "Reflection" ); */
i.putReference(r),t.putList(n("null"),i),executeAction(n("Hd  "),t,DialogModes.NO);var o=new ActionDescriptor,a=new ActionList,s=new ActionReference;s.putProperty(n("Lyr "),n("Bckg")),a.putReference(s),o.putList(n("null"),a),executeAction(n("Shw "),o,DialogModes.NO);var p=new File(e+"/_Schatten__11F-innen");tiffSaveOptions=new TiffSaveOptions,tiffSaveOptions.embedColorProfile=!0,tiffSaveOptions.alphaChannels=!1,tiffSaveOptions.layers=!1,tiffSaveOptions.byteOrder=ByteOrder.IBM,tiffSaveOptions.annotations=!1,tiffSaveOptions.transparency=!1,tiffSaveOptions.imageCompression=TIFFEncoding.TIFFLZW,app.activeDocument.saveAs(p,tiffSaveOptions,!0,Extension.LOWERCASE)}(),function(){for(;documents.length>0;)activeDocument.close(SaveOptions.DONOTSAVECHANGES)}(),app.preferences.rulerUnits=startRulerUnits,app.displayDialogs=startDisplayDialogs}id2ps_schatten();